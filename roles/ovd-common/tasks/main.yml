# Copyright (C) 2018 Inuvika Inc.
# https://www.inuvika.com
# Author David PHAM-VAN <d.phamvan@inuvika.com> 2018
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
- when: ovd_best_practices is defined and ovd_best_practices|bool==true
  set_fact:
    ovd_as_isolation: true

- name: Detect Ovd Windows Application setup URL
  local_action: get_windows_aps_url ovd_url="{{ ovd_repo }}"
  vars:
    ansible_become: no
    ansible_connection: local
    ansible_python_interpreter: "{{ ansible_playbook_python | default(ansible_python.executable) }}"
  register: oas_setup_filename
  changed_when: false

- set_fact:
    ovd_version_detected: '{{ oas_setup_filename.result | regex_search("(\d+\.[^-]+)") | replace("~", ".") }}'

- debug:
    msg: "Using OVD version {{ ovd_version_detected }}"

- name: Check OVD version
  when: check_ovd_version | default('true') | bool
  assert:
    that:
      - ovd_version_detected is version('2.8', '>=')
      - ovd_version_detected is version('3.2', '<')
    msg: "{{ ovd_version_detected }} is not supported"

- name: Check that the OS is x86_64
  assert:
    that:
      - ansible_architecture | regex_search('64')
    msg: "{{ ansible_architecture }} architecture is not supported"

- name: Check the "ovd_www_config" setting value
  assert:
    that:
      - ovd_www_config in ('apache-mod', 'apache-fpm')
    msg: ovd_www_config settings does not support value "{{ ovd_www_config }}"

- name: Set the default OVD Administration API method
  when: ovd_sm_admin_api is not defined
  set_fact:
    ovd_sm_admin_api: "{{ 'soap' if ovd_version_detected is version('3.0.99', '<') else 'rest' }}"

- name: Check the "ovd_sm_admin_api" setting value
  assert:
    that:
      - ovd_sm_admin_api in ('rest', 'soap')
    msg: ovd_sm_admin_api settings does not support value "{{ ovd_sm_admin_api }}"

- include_tasks: debian.yml
  when: ansible_os_family == 'Debian'
  tags: [ovd]

- include_tasks: redhat.yml
  when: ansible_os_family == 'RedHat'
  tags: [ovd]

- include_tasks: windows.yml
  when: ansible_os_family == 'Windows'
  tags: [ovd]
